// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
  output   = "../lib/generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum InvoiceType {
  PURCHASE
  SALE
}

enum JournalLineType {
  CREDIT
  DEBIT
}

enum InvoiceStatus {
  PENDING
  PAID
  OVERDUE
}

enum PartyType {
  VENDOR
  CUSTOMER
}

enum ChartAccountType {
  ASSET
  LIABILITY
  EQUITY
  INCOME
  EXPENSE
}

model Business {
  id           String          @id @default(cuid())
  legalName    String          @unique
  address      String
  country      String 
  vatNumber    String
  bankIban     String 


  parties      Party[]
  invoices     Invoice[]
}

model Party {
  id           String          @id @default(cuid())
  businessId   String
  business     Business        @relation(fields: [businessId], references: [id])

  type          PartyType
  legalName     String
  vatNumber     String?
  fiscalId      String?
  email         String
  phone         String?
  address       String?
  country       String?
  notes         String?

  salesInvoices Invoice[] @relation("CustomerInvoices")
  purchaseInvoices  Invoice[] @relation("VendorInvoices")
}

model Invoice {
  id           String          @id @default(cuid())
  type         InvoiceType
  number       String
  issueDate    DateTime @default(now())
  dueDate      DateTime?
  description  String?
  subtotal     Decimal  @default(0)
  tax          Decimal  @default(0) 
  total        Decimal  @default(0)
  currency     String   @default("EUR")
  status       InvoiceStatus @default(PENDING)

  businessId  String
  business    Business  @relation(fields: [businessId], references: [id])

  customerId  String?
  customer    Party? @relation("CustomerInvoices", fields: [customerId], references: [id], onDelete: Cascade)

  vendorId    String?
  vendor      Party? @relation("VendorInvoices", fields: [vendorId], references: [id], onDelete: Cascade)

  items       InvoiceItem[]
  payments    Payment[]

  journalEntries  JournalEntry[]
}

model InvoiceItem {
  id           String          @id @default(cuid())
  description  String
  quantity     Int
  unitPrice    Decimal
  total        Decimal
  
  invoiceId    String
  invoice       Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
}

model Payment {
  id          String   @id @default(cuid())
  date        DateTime
  amount      Decimal
  method      String?
  note        String?

  invoiceId   String
  invoice     Invoice   @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  journalEntries  JournalEntry[]
}

model ChartAccount {
  id          String   @id @default(cuid())
  code        String   @unique
  name        String   @unique
  type        ChartAccountType
  isSystem    Boolean
  createdAt   DateTime @default(now())

  journalLines  JounralLine[]
}

model JournalEntry {
  id          String   @id @default(cuid())
  date        DateTime @default(now())
  description String?
  sourceType  String?
  
  invoiceId   String?
  paymentId   String?

  invoice     Invoice? @relation(fields: [invoiceId], references: [id])
  payment     Payment? @relation(fields: [paymentId], references: [id])

  journalLines  JounralLine[]
}

model JounralLine {
  id              String   @id @default(cuid())

  jounralEntryId  String
  journalEntry   JournalEntry @relation(fields: [jounralEntryId], references: [id])

  chartAccountId  String
  chartAccount     ChartAccount @relation(fields: [chartAccountId], references: [id])

  description     String
  amount          Int
  type            JournalLineType
  createdAt       DateTime  @default(now())
}
